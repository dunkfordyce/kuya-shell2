<html>
<head>
    <style>
    @font-face {
      font-family: 'icons';
      src: url('ninjaicons.woff') format('woff');
      font-style: normal;
      font-weight: normal;
    }

    .icon {
        font-family: 'icons';
        vertical-align: text-bottom;
    }

    #output { 
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 20px;       
        background: #111;
        color: white;
    }   

    #output > div {
        border-bottom: 1px dashed #333;
        font-family: monospace;
    }

    #output > div > div.output-header * { 
        font-size: 12px;
    }

    #output > div > div.target { 
        padding-left: 10px;
    }

    .output-options {
        cursor: pointer;
    }
    .output-command { 
        color: #a44;
        padding-left: 5px;
    }

    #output div.loading { 
        background: #422;
    }
    
    #input { 
        position: absolute;
        left: 0;
        right: 0;
        height: 20px;
        bottom: 0;
        overflow: hidden;
    }
    #input * { 
        font-family: monospace;
    }
    #input-text { 
        position: absolute;
        top: 0;
        bottom: 0;
        border: none;
        width: 100%;
        padding-left: 4px;
    }
    </style>
</head>
<body>

<div id="output"></div>
<div id="input">
    <span id="input-prompt"></span><input type="text" id="input-text"/>
</div>

<script type="text/html" id="template-output">
<div class="loading">
    <div class="output-header"><span class="icon output-options">g</span><span class="output-command"><%=cmd%></span></div>
    <div class="target"></div>
</div>
</script>

<script type="text/html" id="template-schema-FileList">
<ul>
    <% _.each(data.files, function(file) { %>
    <li><%=file%></li>
    <% }); %>
</ul>
</script>
<script type="text/html" id="template-schema-json">
<%=JSON.stringify(data)%>
</script>
<script type="text/html" id="template-schema-error">
<span class="icon" style="color: red">!</span> <span style="color: red"><%=data.message%></span>
</script>

<script src="jquery-1.6.1.js"></script>
<script src="underscore.js"></script>
<script src="parser.js"></script>
<script src="jsonselect.js"></script>
<script>

var schema_templates = {};
$('script[id^=template-schema-]').each(function(idx, template) { 
    schema_templates[template.id.replace('template-schema-', '')] = _.template($(template).text());
});

var $output = $('#output');
var template_output = _.template($('#template-output').text());

var $input = $('#input-text')
    .focus()
    .keypress(function(e) { 
        if( e.which == 13 ) { 
            var $c = $(template_output({cmd: $input.val()})).appendTo($output);
            var cl = parse($input.val());
            $input.val('');
            $c.data('call_list', cl);
            cl.execute().then(function(ret) { 
                $c.removeClass('loading');
                var $t = $c.find('.target');
                $.each(ret, function(key, val) { 
                    var template = schema_templates[val.schema] || schema_templates['json'];
                    $t.append(template(val));
                });

            });
        }
    })
;


$.ajaxSetup({
    dataType: 'json'
});

var context = {
    command: function(cmd, args) { 
        return $.ajax('/context/'+this.id+'/command', {
            type: 'POST',
            data: JSON.stringify({cmd: cmd, args: args}),
            processData: false,
            contentType: 'application/json'
        }).success(function(ret) { 
            console.log(ret);
        });
    },
    filelist: function(pattern) { 
        return this.command('filelist', [pattern]);
    }
};

var C = function() { 
    return context.filelist.apply(context, arguments);
};
C.__proto__ = context;

function render(ret) { 
    $t.html( schema_templates[ret.schema](ret) );
}

function tojson_replacer(key, value) { 
    if( key[0] == '_' ) { return undefined; }
    if( value.toJSON ) { return value.toJSON(); }
    return value;
}

function tojson(obj) { 
    if( obj.toJSON ) { return JSON.stringify(obj.toJSON(), tojson_replacer); }
    return JSON.stringify(obj, tojson_replacer);
}

var got_context = $.ajax('/context', {
    type: 'POST',
}).success(function(data) { 
    context.id = data.id;
    context.path = data.path;
    $('#input-prompt').html(context.path+'$');
    console.log(context.id, context.path);
});

function Call(cmd, args, opts) { 
    this.id = null;
    this.cmd = cmd;
    this.args = args;
    this.opts = opts;   
    this.input = null;
}
Call.prototype.set_input = function(input_call) { 
    console.assert( input_call.id !== null );
    this.input = input_call.id;
};

function CallChain() { 
    this._idc = 0;
    this.debug = false;
    this.calls = {};
}
CallChain.prototype.add = function(cmd, args, opts) { 
    var call = new Call(cmd, args, opts);
    call.id = this._idc ++;
    this.calls[call.id] = call;
    return call;
};
CallChain.prototype.execute = function() { 
    return $.ajax('/context/'+context.id+'/chain', {
        type: 'POST',
        data: JSON.stringify(this),
        processData: false,
        contentType: 'application/json'
    }).success(function(data) { 
        console.log('callchain execute received', data);
        window.$0 = data;
    });
};

got_context.then(function() { 
    /*
    var c = new CallChain();
    c.debug = true;
    var c1 = c.add('test', ['a']);
    var c2 = c.add('test', ['b']);
    var s = c.add('select', ['.args']);
    c2.set_input(c1);
    s.set_input(c2);
    c.execute();
    */
    parse("ls *.js").execute();
    parse('ls *.js */*.js | select ".files :contains(comm)"').execute();
});

function parse(s) { 
    var commands = commands_split( quote_split(s) );
    console.log(commands);

    var cc = new CallChain();
    //cc.debug = true;

    _.each(commands, function(command) { 
        var cmd = command.shift();
        var input = null;
        if( cmd == '|' ) { 
            input = cc.calls[cc._idc -1];
            cmd = command.shift();
        }
        var args = command;
        var c = cc.add(cmd, args, {});
        if( input !== null ) { 
            c.set_input(input);
        }
    });

    console.dir(cc.calls);
    return cc;
}


</script>

</body>
</html>
